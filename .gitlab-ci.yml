variables:
  VERSION:
    value: ""
    description: "The version to release"
  BLOBS_BUCKET:
    value: "public-datadog-firehose-nozzle-blobs"
    description: "Bucket where the generated artifacts (blobs) is stored"
  RELEASE_BUCKET:
    value: "cloudfoundry.datadoghq.com/datadog-firehose-nozzle"
    description: "Bucket where the actual nozzle release is be stored"
  DRY_RUN:
    value: "true"
    description: "Set to true to do a dry run"
  REPO_BRANCH:
    value: "master"
    description: "The branch to use"

datadog-firehose-nozzle-release:
  stage: deploy
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/gitlab_agent_deploy:v48815877-9bfad02c
  tags: ["runner:main"]
  when: manual
  script:
    - "curl -o go1.24.2.linux-amd64.tar.gz https://golang.org/dl/go1.24.2.linux-amd64.tar.gz -L"
    - "tar -xzf go1.24.2.linux-amd64.tar.gz"
    - "export PATH=$PATH:$(pwd)/go/bin"
    - "export GOROOT=$(pwd)/go"
    - set +x
    - ./scripts/publish.sh

update_go_version:
  stage: update-go
  image: bosh/bosh-cli:latest
  variables:
    TARBALL_NAME: "go${GO_VERSION}.linux-amd64.tar.gz"
    TARBALL_URL: "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz"
    BLOB_PATH: "golang/${TARBALL_NAME}"
    PACKAGE_NAME: "golang${GO_VERSION}"
  script:
    - |
      if [ -z "$GO_VERSION" ]; then
        echo "âŒ GO_VERSION must be provided as a CI variable (e.g., 1.24.2)"
        exit 1
      fi

    - echo "ðŸ§¹ Cleaning up existing Go packages"
    - |
      for pkg in packages/golang*; do
        if [ -d "$pkg" ] && [[ "$pkg" != "packages/${PACKAGE_NAME}" ]]; then
          echo "Removing package dir: $pkg"
          rm -rf "$pkg"
        fi
      done

    - echo "ðŸ” Removing old Go blobs via bosh remove-blob"
    - |
      if bosh blobs | grep -q 'golang/go'; then
        for blob in $(bosh blobs | grep 'golang/go' | awk '{print $1}'); do
          if [[ "$blob" != "$BLOB_PATH" ]]; then
            echo "Removing blob: $blob"
            bosh remove-blob "$blob"
          fi
        done
      else
        echo "No old Go blobs found."
      fi

    - echo "â¬‡ï¸ Downloading Go tarball: $TARBALL_URL"
    - curl -fsSL "$TARBALL_URL" -o "/tmp/${TARBALL_NAME}"

    - echo "ðŸ“¦ Creating package directory: packages/${PACKAGE_NAME}"
    - mkdir -p "packages/${PACKAGE_NAME}"

    - echo "ðŸ“ Writing spec to packages/${PACKAGE_NAME}/spec"
    - cat > "packages/${PACKAGE_NAME}/spec" <<EOF
---
name: ${PACKAGE_NAME}

files:
- ${BLOB_PATH}
EOF

    - echo "âž• Adding blob to release: ${BLOB_PATH}"
    - bosh add-blob "/tmp/${TARBALL_NAME}" "${BLOB_PATH}"

    - echo "ðŸ”„ Syncing blobs from blobstore"
    - bosh sync-blobs

    - echo "ðŸ“¤ Uploading blobs to blobstore"
    - bosh upload-blobs

    - echo "ðŸ§ª Validating release creation"
    - bosh create-release --force --tarball="datadog-firehose-nozzle.tgz"

  rules:
    - if: '$GO_VERSION'
      when: always
