#!/bin/bash -e

DATADOG_URL=<%= p("datadog.api_url") %>
SYS_DIR=/var/vcap/sys
RUN_DIR=$SYS_DIR/run/datadog-firehose-nozzle
LOG_DIR=$SYS_DIR/log/datadog-firehose-nozzle
TMP_DIR=$SYS_DIR/tmp/datadog-firehose-nozzle
ZIPFILE=$TMP_DIR/flare.zip
PIDFILE=$RUN_DIR/datadog-firehose-nozzle.pid
CONFIG_FILE=/var/vcap/jobs/datadog-firehose-nozzle/config/datadog-firehose-nozzle.json

if [ -z ${1+x} ]; then
  echo "Please set the caseid as the first field and your email as the second"
  exit 1
end

if [ -z ${2+x} ]; then
  echo "Please set the caseid as the first field and your email as the second"
  exit 1
end

CASE_ID=$1
EMAIL=$2

if [ -f $ZIPFILE ]; then
  rm $ZIPFILE
fi

pushd $LOG_DIR
  for file in $(ls); do
    zip -r $ZIPFILE $file
  done
popd

mkdir $TMP_DIR/config

CLEAN_CONFIG_FILE=$TMP_DIR/config/datadog-firehose-nozzle.json

pushd $TMP_DIR/config
  python /var/vcap/jobs/datadog-firehose-nozzle/bin/clean_config.py $CONFIG_FILE $CLEAN_CONFIG_FILE
  zip -r $ZIPFILE $CLEAN_CONFIG_FILE
popd

rm -rf $TMP_DIR/config

FLARE_URL=$DATADOG_URL/support/flare/$CASE_ID

curl -F "case_id=$CASE_ID" -F "email=$EMAIL" -F "flare_file=@$ZIPFILE" $FLARE_URL
